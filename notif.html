<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifikasi Ekstrakurikuler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        'app-blue': '#4F46E5',
                        'app-gray-text': '#4B5563',
                        'app-bg': '#F9FAFB',
                        'app-card-border': '#E5E7EB',
                        'app-badge-bg': '#EEF2FF',
                        'app-unread-bg': '#FFFFFF',
                        'app-read-bg': '#E5E7EB',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F3F4F6;
        }

        .location-icon {
            color: #EF4444;
        }

        /* Animasi fade up */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-4xl mx-auto min-h-screen p-6 sm:p-8 bg-white rounded-xl shadow-xl flex flex-col">

        <header class="mb-8 pt-10">
            <div class="flex items-center space-x-3 text-gray-800">
                <a href="daftar-ekstra.html" class="h-6 w-6 cursor-pointer hover:text-app-blue">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </a>
                <h1 class="text-xl sm:text-4xl font-semibold">
                    Notifikasi Ekstrakurikuler
                </h1>
            </div>
            <p class="mt-4 text-app-gray-text text-sm sm:text-base">
                Berikut adalah pengumuman dan informasi terbaru terkait semua kegiatan ekstrakurikuler sekolah.
            </p>
            <div class="flex flex-col sm:flex-row gap-4 mt-4">
                <button id="refresh-notifications" class="text-xs font-medium text-app-blue hover:text-blue-700 transition duration-150 px-4 py-2 border border-app-blue rounded-lg">
                    Muat Ulang
                </button>
                <button id="mark-all-read" class="text-xs font-medium text-app-blue hover:text-blue-700 transition duration-150 px-4 py-2 border border-app-blue rounded-lg">
                    Tandai Semua Sudah Dibaca
                </button>
            </div>
        </header>

        <div id="notifications-container" class="space-y-4">
            <!-- Notifikasi akan ditampilkan di sini -->
        </div>

        <div class="text-center mt-8 pb-10">
            <button id="load-more-btn" class="text-sm font-medium text-app-blue hover:text-blue-700 transition duration-150">
                Lihat Lainnya
            </button>
        </div>

    </div>

    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-300">
            <div class="flex justify-between items-center p-5 border-b border-gray-200">
                <h3 id="modal-title" class="text-xl font-bold text-gray-900">Judul Notifikasi</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <p id="modal-description" class="text-app-gray-text text-base">Deskripsi lengkap notifikasi.</p>
                <div class="flex items-center text-sm text-app-gray-text">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-app-blue mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span id="modal-datetime">2025-11-20 - 15:00</span>
                </div>
                <div class="flex items-center text-sm text-app-gray-text">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 location-icon mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                    </svg>
                    <span id="modal-location">Lokasi: Lapangan Utama</span>
                </div>
            </div>

            <div class="p-5 border-t border-gray-200 flex justify-between">
                <button id="modal-delete-btn" class="p-2 bg-transparent rounded-full hover:bg-gray-100 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
                <button id="modal-mark-read-btn" class="px-4 py-2 bg-app-blue text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:bg-gray-400">
                    Tandai Telah Dibaca
                </button>
            </div>
        </div>
    </div>

    <!-- Inisialisasi SQLite.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script>
        // --- 1. Konfigurasi awal ---
        const notificationsContainer = document.getElementById('notifications-container');
        const markAllReadButton = document.getElementById('mark-all-read');
        const loadMoreButton = document.getElementById('load-more-btn');
        const refreshButton = document.getElementById('refresh-notifications');

        const modal = document.getElementById('notification-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalDatetime = document.getElementById('modal-datetime');
        const modalLocation = document.getElementById('modal-location');
        const modalMarkReadBtn = document.getElementById('modal-mark-read-btn');

        // --- 2. Inisialisasi SQLite.js ---
        let db;
        let currentNotifications = [];

        initSqlJs().then(function(SQL) {
            const savedDb = localStorage.getItem('db');
            if (savedDb) {
                const data = JSON.parse(savedDb);
                const buffer = new Uint8Array(data);
                db = new SQL.Database(buffer);
            } else {
                db = new SQL.Database();
            }

            // Pastikan tabel notifikasi ada
            db.run(`
                CREATE TABLE IF NOT EXISTS notifikasi (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    judul TEXT NOT NULL,
                    pesan TEXT NOT NULL,
                    tanggal TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
            `);

            // Fungsi untuk ambil notifikasi dari SQLite dan update UI
            function loadNotificationsFromDB() {
                const result = db.exec(`
                    SELECT judul, pesan, tanggal FROM notifikasi ORDER BY tanggal DESC
                `);

                currentNotifications = [];
                if (result.length > 0 && result[0].values.length > 0) {
                    result[0].values.forEach(row => {
                        currentNotifications.push({
                            id: `admin_${row[2]}`,
                            title: row[0],
                            description: row[1],
                            datetime: row[2],
                            location: "Sekolah",
                            isRead: false
                        });
                    });
                }

                renderNotifications();
            }

            // Jalankan saat database siap
            loadNotificationsFromDB();

        }).catch(err => {
            console.error("Gagal memuat SQLite.js:", err);
            currentNotifications = [];
            renderNotifications();
        });

        // --- 3. Sinkronisasi lintas tab menggunakan BroadcastChannel ---
        const channel = new BroadcastChannel('notifications-channel');

        channel.onmessage = function(event) {
            if (event.data.type === 'NOTIFICATION_ADDED') {
                if (db) {
                    loadNotificationsFromDB();
                }
            }
        };

        // --- 4. Render Notifikasi ---
        function renderNotifications() {
            notificationsContainer.innerHTML = '';

            if (currentNotifications.length === 0) {
                notificationsContainer.innerHTML = '<p class="text-center text-app-gray-text py-10">Tidak ada notifikasi baru saat ini.</p>';
                return;
            }

            // Hapus duplikat berdasarkan ID (jika ada)
            const uniqueNotifications = Array.from(
                new Map(currentNotifications.map(item => [item.id, item])).values()
            );

            uniqueNotifications.forEach((notif, index) => {
                const bgColorClass = notif.isRead ? 'bg-app-read-bg' : 'bg-app-unread-bg';

                const notifCard = document.createElement('div');
                notifCard.className = `p-4 sm:p-6 shadow-md hover:shadow-lg transition-shadow duration-300 rounded-xl border border-app-card-border cursor-pointer ${bgColorClass} fade-in-up`;
                notifCard.style.animationDelay = `${index * 0.1}s`;
                notifCard.setAttribute('data-id', notif.id);

                notifCard.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <h2 class="text-lg font-semibold text-gray-900 mb-2 sm:mb-0">${notif.title}</h2>
                        <span class="text-xs font-medium px-3 py-1 bg-app-badge-bg text-app-blue rounded-full whitespace-nowrap">${notif.datetime}</span>
                    </div>
                    <p class="mt-2 text-sm text-app-gray-text">${notif.description}</p>
                    <div class="mt-2 flex items-center text-xs text-app-gray-text">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 location-icon mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        <span>Lokasi: ${notif.location}</span>
                    </div>
                `;

                notifCard.addEventListener('click', () => openModal(notif));
                notificationsContainer.appendChild(notifCard);
            });
        }

        // --- 5. Modal ---
        function openModal(notif) {
            modalTitle.textContent = notif.title;
            modalDescription.textContent = notif.description;
            modalDatetime.textContent = notif.datetime;
            modalLocation.textContent = `Lokasi: ${notif.location}`;

            modalMarkReadBtn.setAttribute('data-notif-id', notif.id);
            modalDeleteBtn.setAttribute('data-notif-id', notif.id);
            modalMarkReadBtn.disabled = notif.isRead;
            modalMarkReadBtn.textContent = notif.isRead ? 'Sudah Dibaca' : 'Tandai Telah Dibaca';

            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modalMarkReadBtn.removeAttribute('data-notif-id');
            modalDeleteBtn.removeAttribute('data-notif-id');
        }

        function markAsRead(notifId, status = true) {
            const index = currentNotifications.findIndex(n => n.id === notifId);
            if (index !== -1) {
                currentNotifications[index].isRead = status;
                renderNotifications();
            }
        }

        function deleteNotification(notifId) {
            currentNotifications = currentNotifications.filter(n => n.id !== notifId);
            renderNotifications();
            closeModal();
        }

        function markAllAsRead() {
            currentNotifications = currentNotifications.map(notif => ({ ...notif, isRead: true }));
            renderNotifications();
        }

        // --- 6. Event Listeners ---
        modalMarkReadBtn.addEventListener('click', () => {
            const notifId = modalMarkReadBtn.getAttribute('data-notif-id');
            if (notifId && !modalMarkReadBtn.disabled) {
                markAsRead(notifId, true);
                closeModal();
            }
        });

        modalDeleteBtn.addEventListener('click', () => {
            const notifId = modalDeleteBtn.getAttribute('data-notif-id');
            if (notifId) {
                deleteNotification(notifId);
            }
        });

        modalCloseBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        markAllReadButton.addEventListener('click', markAllAsRead);
        refreshButton.addEventListener('click', () => {
            if (db) loadNotificationsFromDB();
        });

        loadMoreButton.addEventListener('click', () => {
            // Contoh logika "Lihat Lainnya" jika diperlukan
            // Misalnya, menambahkan notifikasi dummy dari database
            // Atau memuat lebih banyak dari database jika ada pagination
            // Untuk saat ini, tidak ada aksi default jika hanya dari DB
            alert('Semua notifikasi telah dimuat.');
        });

        // --- 7. Sinkronisasi lintas tab: Admin Dashboard mengirim notifikasi â†’ ini merespons ---
        window.addEventListener('storage', (e) => {
            if (e.key === 'notifications') {
                // Jika Admin Dashboard menyimpan ke localStorage, halaman ini merespons
                const saved = JSON.parse(e.newValue || '[]');
                currentNotifications = [...saved]; // Hanya notifikasi admin sekarang
                renderNotifications();
            }
        });

        // --- 8. Render awal ---
        renderNotifications();
    </script>
</body>
</html>